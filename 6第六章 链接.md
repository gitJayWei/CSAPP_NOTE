##  6. 链接

- 链接(linking)，是把各种代码和数据片段收集并组合成为一个单一文件的过程；这个文件可被加载(复制)到内存中并执行；
- 链接可在不同阶段执行：编译时(对应静态链接)；加载时与执行时(对应动态链接)；
- 在现代系统中，链接是由链接器(linker)自动执行的；

### 6.0. 前置知识

#### 6.0.0. 编译器驱动程序

- 编译器驱动程序是编译过程的总指挥，它会在需要时自动调用 语言处理器，编译器，汇编器和链接器；

  > 比如GUN编译系统的gcc驱动程序；

##### 工作流程

- **预处理**：执行 # 开头的指令，将头文件内容直接插入源文件，并展开宏定义，生成一个纯C代码的 .i 文件；

- **编译**：将预处理得到的 .i 文件进行词法分析，语法分析，语义分析，并生成汇编的 .s 文件；
- **汇编**：将 .s 汇编代码逐句翻译为机器指令，生成一个二进制的 .o 目标文件；
- **链接**：将多个 .o 目标文件与库文件合并在一起，解析文件之间 的函数调用和变量引用，确定它们的最终内存地址，并生成一个完整的，可以直接运行的可执行目标文件；

<img src="./assets/6.1. 编译器驱动程序工作流程图.png" alt="6.1. 编译器驱动程序工作流程图" style="zoom: 50%;" />



#### 6.0.1. 可重定位目标文件

- 一个典型的ELF可重定位目标文件 (.o 文件)由以下几个部分组成：

<img src="./assets/6.4. ELF可重定位目标文件.png" alt="6.4. ELF可重定位目标文件" style="zoom: 50%;" />

- **ELF头**：位于文件开头，描述了文件的基本信息，如文件类型(可重定位、可执行)，硬件平台以及**节头部表**的位置；
- **各个节(Sections)**：文件的核心，不同数据被分门别类存放在不同节中，每个节也有一个固定大小的条目用以记录节的有关信息：
  
  - `.text`：存放编译后的**机器代码**；
  - `.rodata`：存放**只读数据** (如字符串常量)；
  - `.data`：存放**已初始化**的**全局变量**和**静态变量**；
  - `.bss`：存放**未初始化**的全局变量和静态变量；
  - `.symtab`：**符号表**，记录文件中定义和引用的函数名、全局变量名等信息；
  - `.rel.text`和`.rel.data`：**重定位表**，记录在链接时`.text`和`.data`节中哪些地址需要被修改；
  - `.line`和`.debug`：-g编译选项才有；
  - `.strtab`：字符串表，存储`.symtab`、`.debug`等符号表及节头部表中的节名字符串；
- **节头部表**：位于文件末尾，描述了每个节的**名称、大小、在文件中的位置**等；

  

#### 6.0.2. 符号与符号表

##### 符号

- 对于链接器来说，符号只有三类：
  - **全局符号**：由该文件定义且能被其它文件引用；对应C中非 static 的函数和全局变量；
  - **外部符号**：由其它文件定义，被该文件引用；对应其它文件中非 static 的函数和全局变量；
  - **局部符号**：仅在该文件中被定义和引用；对应C中带 static 的函数和全局变量；
- 注意：
  - 本地非静态程序变量(如函数中普通局部变量)在运行时由栈管理，不会出现在符号表 (.symtab) 中；
  - 带 static 的局部变量会被编译器分配在 .data 或 .bss 段，并在符号表中创建唯一命名的局部符号(如x.1与x.2)以避免命名冲突；

##### 符号表 ？？？？？？？？？？？？？？？？？？？？？？

- ELF 符号表的每个条目由结构体`Elf64_Symbol`定义，各字段含义如下：
  - `name`：字符串表的字节偏移，指向符号的空终止字符串名称。
  - `type`（4 位）：表示符号类型，如**函数（FUNC）\**或\**数据（OBJECT）**。
  - `binding`（4 位）：表示符号作用域，如**局部（LOCAL）\**或\**全局（GLOBAL）**。
  - `reserved`：未使用，保留字段。
  - `section`：节头部表的索引，标识符号所属的段（如`.text`、`.data`）。
  - `value`：符号的地址。可重定位模块中是 “定义目标节起始位置的偏移”；可执行文件中是**绝对运行时地址**。
  - `size`：符号的大小（以字节为单位）。
- 此外，文中还提到 **伪节（pseudosection** 的概念：
  - `ABS`：无需重定位的符号；
  - `UND`：未定义符号（即外部符号，如条目 10 的`sum`）；
  - `COMMON`：未分配位置的未初始化数据（对应**未初始化的全局变量**）；
  - `.bss`：未初始化的静态变量，或初始化为 0 的全局 / 静态变量。

### 6.1. 静态链接

- 静态链接器：在编译时将多个可重定位目标文件及其依赖的静态库合并，生成一个完全链接，可被加载执行的可执行目标文件

- **符号解析 (symbol resolution)**：将一个文件中对符号 (如函数名，全局变量名) 的**引用**，与另一个文件中对该符号的**定义**匹配；
- **重定位 (relocation)**：将多个可重定位目标文件中的数据段和代码段合并，并为它们分配最终的内存地址；

#### 6.1.0. 符号解析

#### 6.1.1. 重定位

### 6.2. 动态链接

动态链接共享库，从应用程序中加载和链接共享库，位置无关代码

### 附1 目标文件(是放在前置知识还是附？考虑中)

- 目标文件 (object file) 不止可重定位目标文件一种，而是有三种形式：
  - 可重定位目标文件 (.o 文件)：包含基础的二进制代码和数据，可以与其它 .o 文件链接，生成可执行目标文件；
  - 可执行目标文件：包含所有的二进制代码和数据，可以直接被加载器加载到内存中并执行；
  - 共享目标文件：特殊的可重定位目标文件，也称为动态链接库，可以在程序启动或运行时被动态地加载到内存，供多个程序共享使用；
- 现代 Linux/Unix 系统采用**ELF (可执行可链接格式)**作为目标文件的标准格式；

可执行目标文件，加载可执行目标文件

### 附2 技巧与工具

库打桩机制，处理目标文件的工具
